name: Weekly Community Scan

on:
  schedule:
    - cron: '0 9 * * 0'  # Sundays at 9 AM UTC
  workflow_dispatch:  # Manual trigger for testing

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  scan-community:
    runs-on: ubuntu-latest

    outputs:
      has_suggestions: ${{ steps.parse.outputs.actions_count != '0' }}
      findings: ${{ steps.parse.outputs.findings_count }}
      current_date: ${{ steps.current-date.outputs.current_date }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read last scan date
        id: last-scan
        run: |
          if [ -f .github/last-community-scan.txt ]; then
            LAST_SCAN=$(cat .github/last-community-scan.txt | tr -d '\n')
          else
            LAST_SCAN="2026-01-01"
          fi
          echo "last_scan=$LAST_SCAN" >> $GITHUB_OUTPUT
          echo "Last scan date: $LAST_SCAN"

      - name: Get current date
        id: current-date
        run: |
          CURRENT_DATE=$(date +%Y-%m-%d)
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "Current date: $CURRENT_DATE"

      - name: Read analysis prompt
        run: |
          # Store prompt in file to avoid shell escaping issues
          cat .github/prompts/analyze-community.md > /tmp/community_prompt.md

      - name: Scan community with Claude
        id: scan
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt_file: /tmp/community_prompt.md
          prompt: |
            ---

            ## Scan Parameters

            **Scan Period:** ${{ steps.last-scan.outputs.last_scan }} to ${{ steps.current-date.outputs.current_date }}

            Please search for and analyze Claude Code discussions from this time period across:
            - Reddit (r/ClaudeAI, r/programming)
            - Hacker News
            - Popular dev blogs
            - Official Anthropic community channels

            Focus on finding actionable insights that could improve the SDLC Wizard.
            Most content will be noise - that's expected. Only report genuinely useful findings.
          direct_prompt: true
          model: claude-sonnet-4-20250514
          allowed_tools: "WebSearch,WebFetch"

      - name: Save scan result to file
        env:
          # Use env to safely pass potentially malicious content
          SCAN_RESPONSE: ${{ steps.scan.outputs.response }}
        run: |
          # Write to file via env var (safe from injection)
          printf '%s' "$SCAN_RESPONSE" > /tmp/scan_result.json

      - name: Parse scan result
        id: parse
        run: |
          # Read from file (safe) instead of shell variable interpolation
          NOTHING_NOTABLE=$(jq -r '.nothing_notable // false' /tmp/scan_result.json 2>/dev/null || echo "false")
          FINDINGS_COUNT=$(jq -r '.findings | length // 0' /tmp/scan_result.json 2>/dev/null || echo "0")
          ACTIONS_COUNT=$(jq -r '.recommended_actions | length // 0' /tmp/scan_result.json 2>/dev/null || echo "0")

          echo "nothing_notable=$NOTHING_NOTABLE" >> $GITHUB_OUTPUT
          echo "findings_count=$FINDINGS_COUNT" >> $GITHUB_OUTPUT
          echo "actions_count=$ACTIONS_COUNT" >> $GITHUB_OUTPUT

          echo "Nothing notable: $NOTHING_NOTABLE"
          echo "Findings count: $FINDINGS_COUNT"
          echo "Recommended actions: $ACTIONS_COUNT"

      - name: Update scan date
        run: |
          echo "${{ steps.current-date.outputs.current_date }}" > .github/last-community-scan.txt

      - name: Build issue body
        if: steps.parse.outputs.nothing_notable != 'true' && steps.parse.outputs.findings_count != '0'
        run: |
          cat > /tmp/issue_body.md << 'ISSUEEOF'
          ## Community Digest

          **Scan Period:** ${{ steps.last-scan.outputs.last_scan }} to ${{ steps.current-date.outputs.current_date }}
          **Findings:** ${{ steps.parse.outputs.findings_count }}
          **Recommended Actions:** ${{ steps.parse.outputs.actions_count }}

          ### Full Scan Result
          ```json
          ISSUEEOF

          cat /tmp/scan_result.json >> /tmp/issue_body.md

          cat >> /tmp/issue_body.md << 'ISSUEEOF'
          ```

          ### Review Notes
          - Most community content is noise - that's expected
          - Only act on findings that genuinely align with wizard philosophy
          - When in doubt, don't add it

          ---
          *Generated by weekly-community workflow*
          ISSUEEOF

      - name: Create digest issue
        if: steps.parse.outputs.nothing_notable != 'true' && steps.parse.outputs.findings_count != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "Community Digest: Week of ${{ steps.current-date.outputs.current_date }}" \
            --label "community-digest" \
            --label "auto-generated" \
            --body-file /tmp/issue_body.md

      - name: Commit scan date update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/last-community-scan.txt
          git diff --staged --quiet || git commit -m "chore: update last-community-scan to ${{ steps.current-date.outputs.current_date }}"
          git push || echo "Nothing to push"

      - name: Log if nothing notable
        if: steps.parse.outputs.nothing_notable == 'true' || steps.parse.outputs.findings_count == '0'
        run: |
          echo "No notable community findings this week. This is expected - most weeks are quiet."
          echo "Scan date updated to ${{ steps.current-date.outputs.current_date }}"

  # E2E Testing: Validate community-suggested improvements
  e2e-test:
    needs: scan-community
    if: needs.scan-community.outputs.has_suggestions == 'true'
    runs-on: ubuntu-latest

    outputs:
      verdict: ${{ steps.verdict.outputs.verdict }}
      baseline_score: ${{ steps.baseline.outputs.score }}
      candidate_score: ${{ steps.candidate.outputs.score }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code
          claude --version

      # Baseline: Current SDLC docs
      - name: Baseline - Current SDLC (Tier 2)
        id: baseline
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Running baseline evaluation with current SDLC docs"

          # Use shared evaluation script
          RESULT=$(./tests/e2e/run-tier2-evaluation.sh \
            tests/e2e/scenarios/medium-add-feature.md)

          SCORES=$(echo "$RESULT" | grep '^scores=' | cut -d= -f2)
          MEAN=$(echo "$RESULT" | grep '^score=' | cut -d= -f2)
          CI_RESULT=$(echo "$RESULT" | grep '^ci=' | cut -d= -f2-)

          echo "scores=$SCORES" >> $GITHUB_OUTPUT
          echo "score=$MEAN" >> $GITHUB_OUTPUT
          echo "ci=$CI_RESULT" >> $GITHUB_OUTPUT
          echo "Baseline: $CI_RESULT"

      # Apply community suggestions
      - name: Apply community suggestions
        id: apply
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Based on the community findings from this week's scan, apply minimal
            targeted improvements to SDLC.md.

            Community findings: ${{ needs.scan-community.outputs.findings }}

            Guidelines:
            - Only apply changes that directly improve SDLC enforcement
            - Keep changes minimal and focused
            - Don't rewrite entire sections
          direct_prompt: true
          model: claude-sonnet-4-20250514

      # Candidate: SDLC with community improvements
      - name: Candidate - With Improvements (Tier 2)
        id: candidate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Running candidate evaluation with community improvements"

          # Use shared evaluation script
          RESULT=$(./tests/e2e/run-tier2-evaluation.sh \
            tests/e2e/scenarios/medium-add-feature.md)

          SCORES=$(echo "$RESULT" | grep '^scores=' | cut -d= -f2)
          MEAN=$(echo "$RESULT" | grep '^score=' | cut -d= -f2)
          CI_RESULT=$(echo "$RESULT" | grep '^ci=' | cut -d= -f2-)

          echo "scores=$SCORES" >> $GITHUB_OUTPUT
          echo "score=$MEAN" >> $GITHUB_OUTPUT
          echo "ci=$CI_RESULT" >> $GITHUB_OUTPUT
          echo "Candidate: $CI_RESULT"

      - name: Determine verdict
        id: verdict
        run: |
          source tests/e2e/lib/stats.sh

          BASELINE_SCORES="${{ steps.baseline.outputs.scores }}"
          CANDIDATE_SCORES="${{ steps.candidate.outputs.scores }}"

          VERDICT=$(compare_ci "$BASELINE_SCORES" "$CANDIDATE_SCORES")
          echo "verdict=$VERDICT" >> $GITHUB_OUTPUT
          echo "Verdict: $VERDICT"

      - name: Update CUSUM
        run: |
          SCORE="${{ steps.baseline.outputs.score }}"
          if [ -n "$SCORE" ] && [ "$SCORE" != "0" ]; then
            ./tests/e2e/cusum.sh --add "$SCORE" || true
          fi

      - name: Create PR with results
        if: steps.verdict.outputs.verdict == 'IMPROVED' || steps.verdict.outputs.verdict == 'STABLE'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(sdlc): incorporate community patterns"
          title: "[${{ steps.verdict.outputs.verdict }}] Community Patterns: Week of ${{ needs.scan-community.outputs.current_date }}"
          body: |
            ## Community Pattern Integration

            **Week:** ${{ needs.scan-community.outputs.current_date }}

            ### E2E Test Results

            | Phase | Score (95% CI) |
            |-------|----------------|
            | Baseline | ${{ steps.baseline.outputs.ci }} |
            | With Changes | ${{ steps.candidate.outputs.ci }} |

            ### Verdict: **${{ steps.verdict.outputs.verdict }}**

            - **IMPROVED**: Community patterns significantly improve SDLC scores
            - **STABLE**: No significant difference (safe to merge if patterns are useful)
            - **REGRESSION**: Patterns hurt scores (don't merge)

            ### Changes Applied
            Based on community findings from this week's scan.

            ---
            *Generated by weekly-community workflow with E2E validation*
          branch: community-patterns/${{ needs.scan-community.outputs.current_date }}
          labels: |
            community-patterns
            e2e-tested
            ${{ steps.verdict.outputs.verdict }}
