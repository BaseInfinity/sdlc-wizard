name: Weekly Community Scan

on:
  schedule:
    - cron: '0 9 * * 0'  # Sundays at 9 AM UTC
  workflow_dispatch:  # Manual trigger for testing

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  scan-community:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read last scan date
        id: last-scan
        run: |
          if [ -f .github/last-community-scan.txt ]; then
            LAST_SCAN=$(cat .github/last-community-scan.txt | tr -d '\n')
          else
            LAST_SCAN="2026-01-01"
          fi
          echo "last_scan=$LAST_SCAN" >> $GITHUB_OUTPUT
          echo "Last scan date: $LAST_SCAN"

      - name: Get current date
        id: current-date
        run: |
          CURRENT_DATE=$(date +%Y-%m-%d)
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "Current date: $CURRENT_DATE"

      - name: Read analysis prompt
        run: |
          # Store prompt in file to avoid shell escaping issues
          cat .github/prompts/analyze-community.md > /tmp/community_prompt.md

      - name: Scan community with Claude
        id: scan
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt_file: /tmp/community_prompt.md
          prompt: |
            ---

            ## Scan Parameters

            **Scan Period:** ${{ steps.last-scan.outputs.last_scan }} to ${{ steps.current-date.outputs.current_date }}

            Please search for and analyze Claude Code discussions from this time period across:
            - Reddit (r/ClaudeAI, r/programming)
            - Hacker News
            - Popular dev blogs
            - Official Anthropic community channels

            Focus on finding actionable insights that could improve the SDLC Wizard.
            Most content will be noise - that's expected. Only report genuinely useful findings.
          direct_prompt: true
          model: claude-sonnet-4-20250514
          allowed_tools: "WebSearch,WebFetch"

      - name: Save scan result to file
        env:
          # Use env to safely pass potentially malicious content
          SCAN_RESPONSE: ${{ steps.scan.outputs.response }}
        run: |
          # Write to file via env var (safe from injection)
          printf '%s' "$SCAN_RESPONSE" > /tmp/scan_result.json

      - name: Parse scan result
        id: parse
        run: |
          # Read from file (safe) instead of shell variable interpolation
          NOTHING_NOTABLE=$(jq -r '.nothing_notable // false' /tmp/scan_result.json 2>/dev/null || echo "false")
          FINDINGS_COUNT=$(jq -r '.findings | length // 0' /tmp/scan_result.json 2>/dev/null || echo "0")
          ACTIONS_COUNT=$(jq -r '.recommended_actions | length // 0' /tmp/scan_result.json 2>/dev/null || echo "0")

          echo "nothing_notable=$NOTHING_NOTABLE" >> $GITHUB_OUTPUT
          echo "findings_count=$FINDINGS_COUNT" >> $GITHUB_OUTPUT
          echo "actions_count=$ACTIONS_COUNT" >> $GITHUB_OUTPUT

          echo "Nothing notable: $NOTHING_NOTABLE"
          echo "Findings count: $FINDINGS_COUNT"
          echo "Recommended actions: $ACTIONS_COUNT"

      - name: Update scan date
        run: |
          echo "${{ steps.current-date.outputs.current_date }}" > .github/last-community-scan.txt

      - name: Build issue body
        if: steps.parse.outputs.nothing_notable != 'true' && steps.parse.outputs.findings_count != '0'
        run: |
          cat > /tmp/issue_body.md << 'ISSUEEOF'
          ## Community Digest

          **Scan Period:** ${{ steps.last-scan.outputs.last_scan }} to ${{ steps.current-date.outputs.current_date }}
          **Findings:** ${{ steps.parse.outputs.findings_count }}
          **Recommended Actions:** ${{ steps.parse.outputs.actions_count }}

          ### Full Scan Result
          ```json
          ISSUEEOF

          cat /tmp/scan_result.json >> /tmp/issue_body.md

          cat >> /tmp/issue_body.md << 'ISSUEEOF'
          ```

          ### Review Notes
          - Most community content is noise - that's expected
          - Only act on findings that genuinely align with wizard philosophy
          - When in doubt, don't add it

          ---
          *Generated by weekly-community workflow*
          ISSUEEOF

      - name: Create digest issue
        if: steps.parse.outputs.nothing_notable != 'true' && steps.parse.outputs.findings_count != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "Community Digest: Week of ${{ steps.current-date.outputs.current_date }}" \
            --label "community-digest" \
            --label "auto-generated" \
            --body-file /tmp/issue_body.md

      - name: Commit scan date update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/last-community-scan.txt
          git diff --staged --quiet || git commit -m "chore: update last-community-scan to ${{ steps.current-date.outputs.current_date }}"
          git push || echo "Nothing to push"

      - name: Log if nothing notable
        if: steps.parse.outputs.nothing_notable == 'true' || steps.parse.outputs.findings_count == '0'
        run: |
          echo "No notable community findings this week. This is expected - most weeks are quiet."
          echo "Scan date updated to ${{ steps.current-date.outputs.current_date }}"
